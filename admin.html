<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Dashboard ACESE ‚Äì IEPP GRABO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--orange:#ff6f00;--vert:#2e7d32;--blanc:#fff;--gris:#f5f5f5;--bleu:#002d72;}
    body{font-family:'Arial', sans-serif;margin:0;background:var(--gris);color:#333}
    /* ===== EN-T√äTE R√âPUBLIQUE ===== */
    .header-top{width:100%;background:var(--bleu);color:var(--blanc);padding:10px 20px;display:flex;justify-content:space-between;align-items:center;font-size:0.85rem;line-height:1.3}
    .header-top .left{text-align:left}
    .header-top .right{text-align:right}
    .header-top .line{border-top:1px solid var(--blanc);margin-top:2px}
    /* ===== EN-T√äTE IEPP ===== */
    .header-main{width:100%;background:linear-gradient(135deg, var(--orange) 0%, var(--vert) 100%);color:var(--blanc);padding:20px;display:flex;justify-content:space-between;align-items:center;font-size:1.2rem;text-shadow:1px 1px 3px rgba(0,0,0,.3)}
    .header-main .left{text-align:left}
    .header-main .right{text-align:right}
    .header-main .line{border-top:1px solid var(--blanc);margin-top:3px}
    .logo{height:60px;margin-left:10px}
    #actions{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;padding:30px}
    .btn{flex:1 1 260px;padding:18px;font-size:1.1rem;border:none;border-radius:15px;cursor:pointer;transition:transform .2s,background .3s;box-shadow:0 4px 8px rgba(0,0,0,.2)}
    .btn.csv{background:var(--orange);color:var(--blanc)}.btn.stats{background:var(--vert);color:var(--blanc)}.btn:hover{transform:scale(1.05)}
    #boxStats{background:var(--blanc);margin:30px;border-radius:20px;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:25px;display:none}
    #boxStats h2{text-align:center;color:var(--vert)}
    table{width:100%;border-collapse:collapse;font-size:.9rem;border-radius:12px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.1)}th,td{border:1px solid var(--orange);padding:6px;text-align:center}th{background:var(--vert-clair);color:var(--blanc)}canvas{max-height:400px;margin-top:20px}
  </style>
</head>
<body>
<!-- ===== EN-T√äTE OFFICIEL ===== -->
<header style="width:100%;background:#002d72;color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;font-size:0.85rem;line-height:1.3">
  <!-- GAUCHE : mentions + logo -->
  <div style="text-align:left">
    <div>MINIST√àRE DE L'√âDUCATION NATIONALE</div>
    <div style="border-top:1px solid #fff;margin-top:2px">ET DE L'ALPHABETISATION</div>
    <div style="border-top:1px solid #fff;margin-top:2px">DRENA DE SAN-PEDRO</div>
    <div style="border-top:1px solid #fff;margin-top:2px">IEPP DE GRABO</div>
    <img src="logogbo.png" alt="Logo IEPP GRABO" style="height:250px;margin-top:40px">
  </div>
  <!-- DROITE : R√©publique -->
  <div style="text-align:right">
    <div>R√âPUBLIQUE DE C√îTE D'IVOIRE</div>
    <div style="border-top:1px solid #fff;margin-top:2px">Union - Discipline - Travail</div>
  </div>
</header>

<!-- ===== EN-T√äTE PRINCIPAL AVEC LOGO ===== -->
<header class="header-main">
  <div class="center">
    <h1>üçä Dashboard ACESE ‚Äì IEPP GRABO üçè</h1>
  </div>
  </header>

<div id="actions">
  <button class="btn csv" onclick="exportGlobal()">üì• Exporter CSV IEPP GLOBALE</button>
  <button class="btn csv" onclick="exportParSecteur()">üì• Exporter CSV par SECTEUR PEDAGOGIQUE</button>
  <button class="btn stats" onclick="afficherStats()">üìä STATISTIQUES ACESE - IEPP GRABO</button>
</div>

<div id="boxStats">
  <h2>Statistiques visuelles</h2>
  <canvas id="chart"></canvas>
</div>

<script>
  const API = window.location.origin;
  async function fetchData() { const res = await fetch(API + '/api/eleves'); return res.json(); }
  async function exportGlobal() {
    const rows = await fetchData();
    let csv = '\uFEFFDRENA;IEPP;Secteur p√©dagogique;√âcole;Nom directeur;Pr√©noms directeur;Contact1;Contact2;Email;Nom √©l√®ve;Pr√©noms √©l√®ve;Sexe;Date naissance;Classe;Nom p√®re;T√©l p√®re;Nationalit√© p√®re;Nom m√®re;T√©l m√®re;Nationalit√© m√®re;Nom t√©moin;T√©l t√©moin\n';
    rows.forEach(lot => {
      const h = [lot.drena, lot.iepp, lot.secteur_pedagogique, lot.nom_ecole, lot.nom_directeur, lot.prenoms_directeur, lot.contact1, lot.contact2 || '', lot.email || ''].map(v => `"${v}"`).join(';');
      JSON.parse(lot.eleves || '[]').forEach(e => {
        csv += h + ';' + [e.nom, e.prenoms, e.sexe, e.date_naissance_probable, e.classe, e.nom_pere, e.numero_pere, e.nationalite_pere, e.nom_mere, e.numero_mere, e.nationalite_mere, e.nom_temoin, e.numero_temoin].map(v => `"${v}"`).join(';') + '\n';
      });
    });
    download(csv, 'ACESE_IEPP_GRABO_GLOBAL.csv');
  }
  async function exportParSecteur() {
    const rows = await fetchData();
    let csv = '\uFEFFSecteur p√©dagogique;√âcole;Nom √©l√®ve;Pr√©noms √©l√®ve;Sexe;Date naissance;Classe;Nom directeur;Contact1\n';
    rows.forEach(lot => {
      JSON.parse(lot.eleves || '[]').forEach(e => {
        csv += [lot.secteur_pedagogique, lot.nom_ecole, e.nom, e.prenoms, e.sexe, e.date_naissance_probable, e.classe, lot.nom_directeur + ' ' + lot.prenoms_directeur, lot.contact1].map(v => `"${v}"`).join(';') + '\n';
      });
    });
    download(csv, 'ACESE_IEPP_GRABO_PAR_SECTEUR.csv');
  }
  async function afficherStats() {
    const rows = await fetchData();
    const box = document.getElementById('boxStats');
    box.style.display = 'block';
    box.scrollIntoView({ behavior: 'smooth' });
    const secteurs = {};
    let total = 0;
    rows.forEach(lot => {
      const s = lot.secteur_pedagogique;
      const nb = JSON.parse(lot.eleves || '[]').length;
      total += nb;
      secteurs[s] = (secteurs[s] || 0) + nb;
    });
    let tbl = `<table><thead><tr><th>Secteur</th><th>Effectifs sans extraits</th></tr></thead><tbody>`;
    Object.entries(secteurs).forEach(([s, nb]) => { tbl += `<tr><td>${s}</td><td>${nb}</td></tr>`; });
    tbl += `</tbody></table><p style="text-align:right;font-weight:bold">TOTAL ACESE ‚Äì IEPP GRABO : ${total} √©l√®ves sans extraits</p>`;
    box.insertAdjacentHTML('afterbegin', tbl);
    const ctx = document.getElementById('chart').getContext('2d');
    if (window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(secteurs), datasets: [{ data: Object.values(secteurs), backgroundColor: ['#ff6f00', '#2e7d32', '#66bb6a', '#e67e22'] }] }, options: { plugins: { title: { display: true, text: 'R√©partition par secteur p√©dagogique' } } } });
  }
  function download(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
  }
</script><center> Applicatif Pr0puls√© par _DJ3K S3PH1R0TH_ - 2025
</body>
</html>
